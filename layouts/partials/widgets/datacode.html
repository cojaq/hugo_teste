{{/* Datacode Widget */}}

{{/* Initialise */}}
{{ $ := .root }}
{{ $st := .page }}

{{ $filter_params := $st.Params.filter_params }}

{{ $headless := (index ($.Site.GetPage "/projects").Resources 0) }}

{{ $categories := where $headless.Params.content.filter_button "category" "ne" "All" }}

{{ $pr := where site.RegularPages "Type" "project" }}
{{/* filter projects pages */}}
{{ if (len $filter_params) ge 1 }}
	{{ $projs := where (where $pr (printf ".Params.%s" (index $filter_params 0)) "ne" nil) (printf ".Params.%s" (index $filter_params 0)) "ne" ""}}
	{{ $.Scratch.Set "projs" $projs}}
	{{ range (after 1 $filter_params) }}
		{{ $.Scratch.Set "projs" ($.Scratch.Get "projs" | union (where (where $pr (printf ".Params.%s" .) "ne" nil) (printf ".Params.%s" .) "ne" "")) }}
	{{ end }}
{{ else }}
	{{ $.Scratch.Set "projs" $pr}}
{{ end }}

{{ $pubs := where site.RegularPages "Type" "publication" }}
{{/* filter publications pages */}}
{{ if (len $filter_params) ge 1 }}
	{{ $publications := where (where $pubs (printf ".Params.%s" (index $filter_params 0)) "ne" nil) (printf ".Params.%s" (index $filter_params 0)) "ne" ""}}
	{{ $.Scratch.Set "publications" $publications}}
	{{ range (after 1 $filter_params) }}
		{{ $.Scratch.Set "publications" ($.Scratch.Get "publications" | union (where (where $pubs (printf ".Params.%s" .) "ne" nil) (printf ".Params.%s" .) "ne" "")) }}
	{{ end }}
{{ else }}
	{{ $.Scratch.Set "publications" $pubs}}
{{ end }}

{{ $projs := ($.Scratch.Get "projs") }}
{{ $publications := ($.Scratch.Get "publications") }}

  {{ range $category := $categories }}
    {{ $p := where $projs "Params.categories" "intersect" (slice $category.category) }}
		{{ range (first 1 $p) }}
		  {{ $project_name := .File.ContentBaseName }}
			{{ $pu := where $publications ".Params.projects" "intersect" (slice $project_name) }} 
			{{ $.Scratch.Set "order_query" (slice . ) }}
			{{ $.Scratch.Set "order_query" ($.Scratch.Get "order_query" | append $pu ) }}
				{{ range (after 1 $p) }}
					{{ $project_name := .File.ContentBaseName }}
			    {{ $pu := where $publications ".Params.projects" "intersect" (slice $project_name) }} 
					{{ $.Scratch.Set "order_query" ($.Scratch.Get "order_query" | append . ) }}
					{{ $.Scratch.Set "order_query" ($.Scratch.Get "order_query" | append $pu ) }}
				{{ end }}
			{{ end }}
			{{ $.Scratch.Set (printf "%s" (urlize $category.category)) ($.Scratch.Get "order_query") }}



  {{ end }}

	{{/*  <script>console.log({{ $pu }});</script> */}}

{{ $query := $publications | union $projs }}

{{/* Sort */}}
<style>
  h3.article.title {
    color: black;
  }
</style>

<div class="row">
  <div class="col-12 col-lg-4 section-heading">
    <h1>{{ with $st.Title }}{{ . | markdownify | emojify }}{{ end }}</h1>
		{{ with $st.Params.subtitle }}  <p>{{ . | markdownify | emojify }}</p>{{ end }}
		<br>
		<p> <i class="fas fa-project-diagram pub-icon" aria-hidden="true"></i> Project </p> 
		<p> <i class="far fa-file-alt pub-icon" aria-hidden="true"></i> Publication </p>
  </div>
  <div class="col-12 col-lg-8">

    {{ with $st.Content }}{{ . }}{{ end }}

    {{ range $category := $categories }}
			{{ $p := where $projs "Params.categories" "intersect" (slice $category.category) }}
			{{ $pu := where $publications "Params.categories" "intersect" (slice $category.category) }}
			{{ $query := $pu | union $p }}
			{{ with $q := $query }}

				<h2>{{ with $category }}{{ .category | markdownify | emojify }}{{ end }}</h2>
				{{ range $post := $q }}

						{{ partial "datacode_li_list" . }}

				{{ end }}
			{{ end }}
		{{ end }}

		{{ $categories_names := (apply $categories "index" "." "category") }}
		{{ $p := where $projs "Params.categories" "intersect" $categories_names }}
		{{ $complement_pr := $projs | complement $p }}
		{{ $pu := where $publications "Params.categories" "intersect" $categories_names }}
		{{ $complement_pu := $publications | complement $pu }}
		{{ $query := $complement_pu | union $complement_pr }}
		
		{{ with $q := $query }}
			{{ $non_category_text := "Non-categorized Items" }}

			<h2>{{ with $non_category_text }}{{ . | markdownify | emojify }}{{ end }}</h2>
			{{ range $post := $query }}

					{{ partial "datacode_li_list" . }}

			{{ end }}
		{{ end }}

  </div>
</div>
